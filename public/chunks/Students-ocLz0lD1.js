import{j as e,C as pe,u as hs,a as gs,S as us}from"../assets/index-DwMAudUK.js";import{r,b as ps,f as fs}from"./vendor-C9PcmKF2.js";import{c as bs}from"./utils-x1PSU_OZ.js";import{C as q}from"./Card-B20gp1TF.js";import{S as Ae,T as js}from"./Table-O3_gXWO4.js";import{T as te,c as Te,U as ys,Z as Me,n as fe,X as je,A as be,_ as H,k as Q,$ as ae,d as ee,e as Ns,a as Ee,a0 as vs,r as ws,B as Ss,M as Cs,g as ye,I as ks,O as Ls,S as Is,P as Ps,a1 as Ds,a2 as $s,b as As}from"./ui-CvMS0gwv.js";import{c as re,u as Ms,a as P}from"./cascade-deletion-BGRb_82-.js";import"./query-BdHdBeoH.js";const Es=({student:h,showInstruments:n=!0,showTeacherAssignments:T=!0,showParentContact:g=!1,onClick:f,onDelete:i,className:m="",isSelectMode:k=!1,isSelected:S=!1,onSelectionChange:L})=>{const N=h.academicInfo.instrumentProgress?.find(j=>j.isPrimary)||h.academicInfo.instrumentProgress?.[0],D=j=>({1:"bg-gray-100 text-gray-800",2:"bg-blue-100 text-blue-800",3:"bg-green-100 text-green-800",4:"bg-yellow-100 text-yellow-800",5:"bg-orange-100 text-orange-800",6:"bg-red-100 text-red-800",7:"bg-purple-100 text-purple-800",8:"bg-indigo-100 text-indigo-800"})[j]||"bg-gray-100 text-gray-800",v=j=>j.split(" ").map(F=>F[0]).join("").slice(0,2),z=j=>({1:"bg-gray-500",2:"bg-blue-500",3:"bg-green-500",4:"bg-yellow-500",5:"bg-orange-500",6:"bg-red-500",7:"bg-purple-500",8:"bg-indigo-500"})[j]||"bg-gray-500",[w,p]=r.useState(!1),b=j=>{j.stopPropagation(),p(!0)},W=()=>{i&&i(h._id),p(!1)},x=()=>{p(!1)},R=j=>{j.stopPropagation(),L&&L(h._id,j.target.checked)};return e.jsxs(q,{className:`relative transition-all duration-200 hover:shadow-md ${f?"cursor-pointer hover:shadow-lg":""} ${S?"ring-2 ring-blue-500 bg-blue-50":""} ${m}`,onClick:f,padding:"md",children:[k&&e.jsx("div",{className:"absolute top-3 right-3",children:e.jsx("input",{type:"checkbox",checked:S,onChange:R,className:"w-4 h-4 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"})}),e.jsxs("div",{className:"flex items-start space-x-4 space-x-reverse",children:[e.jsx("div",{className:`
          w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-sm
          ${N?z(N.currentStage):"bg-gray-500"}
        `,children:v(h.personalInfo.fullName)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:`text-lg font-semibold truncate ${S?"text-blue-900":"text-gray-900"} ${k?"ml-6":""}`,children:h.personalInfo.fullName}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[i&&e.jsx("button",{onClick:b,className:"p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"מחק תלמיד",children:e.jsx(te,{className:"w-4 h-4"})}),e.jsx("div",{className:`w-3 h-3 rounded-full ${h.isActive?"bg-green-400":"bg-gray-300"}`}),e.jsxs("span",{className:"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:["כיתה ",h.academicInfo.class]})]})]}),n&&N&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"כלי ראשי:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:N.instrumentName}),e.jsxs("span",{className:`
                  inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                  ${D(N.currentStage)}
                `,children:["שלב ",N.currentStage]})]})}),T&&e.jsx("div",{className:"mb-3",children:e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm text-gray-600",children:[e.jsx(Te,{className:"w-4 h-4"}),e.jsxs("span",{children:[h.teacherAssignments?.length||0," שיעורים שבועיים"]})]})}),n&&h.academicInfo.instrumentProgress&&h.academicInfo.instrumentProgress.length>1&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"כלים נוספים:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:h.academicInfo.instrumentProgress.filter(j=>!j.isPrimary).map((j,F)=>e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-700",children:[j.instrumentName," (שלב ",j.currentStage,")"]},F))})]}),g&&h.personalInfo.parentName&&e.jsxs("div",{className:"border-t border-gray-100 pt-3 mt-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"פרטי הורה:"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm",children:[e.jsx(ys,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700",children:h.personalInfo.parentName})]}),h.personalInfo.parentPhone&&e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm",children:[e.jsx(Me,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700 font-mono",dir:"ltr",children:h.personalInfo.parentPhone})]})]})]}),e.jsx("div",{className:"border-t border-gray-100 pt-2 mt-2",children:e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse text-sm",children:[e.jsx(Me,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-600 font-mono",dir:"ltr",children:h.personalInfo.phone})]})})]})]}),e.jsx(pe,{isOpen:w,title:"מחיקת תלמיד",message:`האם אתה בטוח שברצונך למחוק את התלמיד ${h.personalInfo.fullName}? פעולה זו לא ניתנת לביטול.`,confirmText:"מחק",cancelText:"ביטול",onConfirm:W,onCancel:x,variant:"danger"})]})},Ts=Es,Rs=({isOpen:h,studentId:n,studentName:T,onClose:g,onConfirm:f})=>{const[i,m]=r.useState(null),[k,S]=r.useState(!1),[L,N]=r.useState(null),[D,v]=r.useState({createSnapshot:!0,skipValidation:!1,deleteDocuments:!0,notifyUsers:!1,reason:"Safe deletion via UI"});r.useEffect(()=>{h&&n&&z()},[h,n]);const z=async()=>{S(!0),N(null);try{const p=await re.previewDeletion(n);m(p)}catch(p){console.error("Error loading deletion preview:",p),N(p.message||"שגיאה בטעינת תצוגה מקדימה")}finally{S(!1)}},w=()=>{f(n,D)};return h?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(fe,{className:"w-6 h-6 text-orange-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"מחיקה מאובטחת"})]}),e.jsx("button",{onClick:g,className:"text-gray-400 hover:text-gray-600",children:e.jsx(je,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-200px)]",children:[e.jsxs("div",{className:"mb-6 p-4 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(be,{className:"w-5 h-5 text-orange-600"}),e.jsxs("span",{className:"font-medium text-orange-900",children:["מחיקת התלמיד: ",T]})]}),e.jsx("p",{className:"text-sm text-orange-700",children:"פעולה זו תמחק את התלמיד וכל הנתונים הקשורים אליו. המערכת תבצע בדיקות בטיחות ותיצור גיבוי לפני המחיקה."})]}),k&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(H,{className:"w-6 h-6 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"טוען תצוגה מקדימה..."})]}),L&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-medium text-red-900",children:"שגיאה"})]}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:L})]}),i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"סיכום השפעה"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:'סה"כ רשומות'}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:i.summary?.totalRecords||0})]}),e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"זמן משוער"}),e.jsxs("div",{className:"text-xl font-bold text-gray-900",children:[i.summary?.estimatedDuration||0," שניות"]})]})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:`p-4 rounded-lg border ${i.summary?.riskLevel==="high"?"bg-red-50 border-red-200":i.summary?.riskLevel==="medium"?"bg-yellow-50 border-yellow-200":"bg-green-50 border-green-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:`w-5 h-5 ${i.summary?.riskLevel==="high"?"text-red-600":i.summary?.riskLevel==="medium"?"text-yellow-600":"text-green-600"}`}),e.jsxs("span",{className:"font-medium",children:["רמת סיכון: ",i.summary?.riskLevel==="high"?"גבוהה":i.summary?.riskLevel==="medium"?"בינונית":"נמוכה"]})]})})}),i.summary?.affectedCollections?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"אזורים מושפעים"}),e.jsx("div",{className:"space-y-2",children:i.summary.affectedCollections.map((p,b)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-50 rounded",children:[e.jsx(ee,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-sm",children:p})]},b))})]}),i.warnings?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"אזהרות"}),e.jsx("div",{className:"space-y-2",children:i.warnings.map((p,b)=>e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-yellow-50 border border-yellow-200 rounded",children:[e.jsx(be,{className:"w-4 h-4 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-sm text-yellow-800",children:p})]},b))})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-3",children:"אפשרויות מחיקה"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:D.createSnapshot,onChange:p=>v(b=>({...b,createSnapshot:p.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"צור גיבוי לפני המחיקה (מומלץ)"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:D.deleteDocuments,onChange:p=>v(b=>({...b,deleteDocuments:p.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"מחק גם קבצים ומסמכים"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:D.notifyUsers,onChange:p=>v(b=>({...b,notifyUsers:p.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"שלח התראות למורים קשורים"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:D.skipValidation,onChange:p=>v(b=>({...b,skipValidation:p.target.checked})),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("span",{className:"text-sm text-gray-700",children:"דלג על בדיקות תקינות (לא מומלץ)"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"סיבת המחיקה"}),e.jsx("textarea",{value:D.reason,onChange:p=>v(b=>({...b,reason:p.target.value})),rows:3,className:"w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",placeholder:"הזן סיבה למחיקה..."})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(Ns,{className:"w-4 h-4"}),e.jsx("span",{children:"המחיקה תחל לאחר אישור"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:g,className:"px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"ביטול"}),e.jsxs("button",{onClick:w,disabled:k||!i?.canProceed,className:"flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(fe,{className:"w-4 h-4"}),"מחק באופן מאובטח"]})]})]})]})}):null},Fs=Rs,Us=({isOpen:h,preview:n,onClose:T})=>{if(!h||!n)return null;const g=i=>{switch(i){case"lessons":return e.jsx(Te,{className:"w-4 h-4"});case"attendance":return e.jsx(ye,{className:"w-4 h-4"});case"orchestras":return e.jsx(Cs,{className:"w-4 h-4"});case"theoryClasses":return e.jsx(Ss,{className:"w-4 h-4"});case"documents":return e.jsx(ws,{className:"w-4 h-4"});case"payments":return e.jsx(vs,{className:"w-4 h-4"});default:return e.jsx(ae,{className:"w-4 h-4"})}},f=i=>{switch(i){case"lessons":return"שיעורים";case"attendance":return"נוכחות";case"orchestras":return"תזמורות";case"theoryClasses":return"תיאוריה";case"documents":return"מסמכים";case"payments":return"תשלומים";case"rehearsals":return"חזרות";case"assignments":return"הקצאות";default:return i}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{className:"w-6 h-6 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"השפעת המחיקה"})]}),e.jsx("button",{onClick:T,className:"text-gray-400 hover:text-gray-600",children:e.jsx(je,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-140px)]",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"סיכום כללי"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsx("div",{className:"text-sm text-blue-600 mb-1",children:'סה"כ רשומות'}),e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:n.summary?.totalRecords||0})]}),e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsx("div",{className:"text-sm text-green-600 mb-1",children:"זמן משוער"}),e.jsxs("div",{className:"text-2xl font-bold text-green-900",children:[n.summary?.estimatedDuration||0,"s"]})]}),e.jsxs("div",{className:`p-4 border rounded-lg ${n.summary?.riskLevel==="high"?"bg-red-50 border-red-200":n.summary?.riskLevel==="medium"?"bg-yellow-50 border-yellow-200":"bg-green-50 border-green-200"}`,children:[e.jsx("div",{className:`text-sm mb-1 ${n.summary?.riskLevel==="high"?"text-red-600":n.summary?.riskLevel==="medium"?"text-yellow-600":"text-green-600"}`,children:"רמת סיכון"}),e.jsx("div",{className:`text-2xl font-bold ${n.summary?.riskLevel==="high"?"text-red-900":n.summary?.riskLevel==="medium"?"text-yellow-900":"text-green-900"}`,children:n.summary?.riskLevel==="high"?"גבוהה":n.summary?.riskLevel==="medium"?"בינונית":"נמוכה"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"פירוט מפורט"}),e.jsx("div",{className:"space-y-4",children:Object.entries(n.details||{}).map(([i,m])=>{if(!m||Array.isArray(m)&&m.length===0)return null;const k=Array.isArray(m)?m.length:m.count||0;return k===0?null:e.jsxs("div",{className:"border border-gray-200 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[g(i),e.jsx("span",{className:"font-medium text-gray-900",children:f(i)})]}),e.jsxs("div",{className:"px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium",children:[k," רשומות"]})]}),Array.isArray(m)&&m.length>0&&e.jsx("div",{className:"p-4 max-h-40 overflow-y-auto",children:e.jsxs("div",{className:"space-y-2",children:[m.slice(0,10).map((S,L)=>e.jsx("div",{className:"text-sm text-gray-600 p-2 bg-gray-50 rounded",children:S.title||S.name||S.date||`פריט ${L+1}`},L)),m.length>10&&e.jsxs("div",{className:"text-sm text-gray-500 text-center py-2",children:["ועוד ",m.length-10," פריטים..."]})]})})]},i)})})]}),n.dependencies?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"תלויות"}),e.jsx("div",{className:"space-y-2",children:n.dependencies.map((i,m)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsx(Ee,{className:"w-5 h-5 text-orange-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-orange-900",children:[i.type,": ",i.entity]}),e.jsx("div",{className:"text-sm text-orange-700",children:i.description})]})]},m))})]}),n.warnings?.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"אזהרות"}),e.jsx("div",{className:"space-y-2",children:n.warnings.map((i,m)=>e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx(Ee,{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsx("span",{className:"text-sm text-yellow-800",children:i})]},m))})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsx("div",{className:`p-4 rounded-lg ${n.canProceed?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${n.canProceed?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:`font-medium ${n.canProceed?"text-green-900":"text-red-900"}`,children:n.canProceed?"ניתן לבצע מחיקה":"לא ניתן לבצע מחיקה עקב תלויות קריטיות"})]})})})]}),e.jsx("div",{className:"flex items-center justify-end p-6 border-t border-gray-200 bg-gray-50",children:e.jsx("button",{onClick:T,className:"px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors",children:"סגור"})})]})})},Os=Us,zs=({isOpen:h,selectedStudentIds:n,onClose:T,onComplete:g})=>{const[f,i]=r.useState("preview"),[m,k]=r.useState(!1),[S,L]=r.useState(null),[N,D]=r.useState([]),[v,z]=r.useState({current:0,total:0,stage:""}),[w,p]=r.useState({success:0,failed:0,details:[]});r.useEffect(()=>{h&&n.length>0&&b()},[h,n]);const b=async()=>{k(!0),L(null);try{const c=n.map(async I=>{try{const $=await re.previewDeletion(I);return{studentId:I,studentName:`תלמיד ${I}`,canDelete:$.canProceed,riskLevel:$.summary?.riskLevel||"low",totalRecords:$.summary?.totalRecords||0,warnings:$.warnings||[],errors:[]}}catch($){return{studentId:I,studentName:`תלמיד ${I}`,canDelete:!1,riskLevel:"high",totalRecords:0,warnings:[],errors:[$.message||"שגיאה בטעינת תצוגה מקדימה"]}}}),y=await Promise.all(c);D(y)}catch(c){console.error("Error loading batch previews:",c),L(c.message||"שגיאה בטעינת תצוגות מקדימות")}finally{k(!1)}},W=async()=>{const c=N.filter(B=>B.canDelete);if(c.length===0){L("אין תלמידים שניתן למחוק");return}i("progress"),z({current:0,total:c.length,stage:"מתחיל מחיקה..."});const y=[];let I=0,$=0;for(let B=0;B<c.length;B++){const Y=c[B];z({current:B+1,total:c.length,stage:`מוחק ${Y.studentName}...`});try{await re.executeDelete(Y.studentId,{createSnapshot:!0,batchMode:!0,batchIndex:B+1,batchTotal:c.length}),I++,y.push({studentId:Y.studentId,studentName:Y.studentName,success:!0,error:null})}catch(G){$++,y.push({studentId:Y.studentId,studentName:Y.studentName,success:!1,error:G.message||"שגיאה במחיקה"})}await new Promise(G=>setTimeout(G,500))}p({success:I,failed:$,details:y}),i("complete")},x=()=>{f!=="progress"&&(f==="complete"&&w.success>0?g():T())};if(!h)return null;const R=N.filter(c=>c.canDelete).length,j=N.filter(c=>c.riskLevel==="high").length,F=N.reduce((c,y)=>c+y.totalRecords,0);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ye,{className:"w-6 h-6 text-red-600"}),e.jsxs("h2",{className:"text-xl font-semibold text-gray-900",children:["מחיקה מרובת תלמידים (",n.length,")"]})]}),e.jsx("button",{onClick:x,disabled:f==="progress",className:"text-gray-400 hover:text-gray-600 disabled:opacity-50",children:e.jsx(je,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"overflow-y-auto max-h-[calc(90vh-180px)]",children:[f==="preview"&&e.jsxs("div",{className:"p-6",children:[m&&e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(H,{className:"w-6 h-6 animate-spin text-primary-600"}),e.jsx("span",{className:"ml-2 text-gray-600",children:"טוען תצוגות מקדימות..."})]}),S&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-medium text-red-900",children:"שגיאה"})]}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:S})]}),N.length>0&&!m&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:n.length}),e.jsx("div",{className:"text-sm text-blue-600",children:"נבחרו"})]}),e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-900",children:R}),e.jsx("div",{className:"text-sm text-green-600",children:"ניתן למחוק"})]}),e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-900",children:j}),e.jsx("div",{className:"text-sm text-red-600",children:"סיכון גבוה"})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:F}),e.jsx("div",{className:"text-sm text-gray-600",children:'סה"כ רשומות'})]})]}),e.jsx("div",{className:"space-y-3",children:N.map(c=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[c.canDelete?e.jsx(ee,{className:"w-5 h-5 text-green-600"}):e.jsx(Q,{className:"w-5 h-5 text-red-600"}),e.jsx("span",{className:"font-medium",children:c.studentName}),e.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium ${c.riskLevel==="high"?"bg-red-100 text-red-800":c.riskLevel==="medium"?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800"}`,children:c.riskLevel==="high"?"סיכון גבוה":c.riskLevel==="medium"?"סיכון בינוני":"סיכון נמוך"})]}),e.jsxs("div",{className:"text-sm text-gray-600",children:[c.totalRecords," רשומות"]})]}),c.warnings.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:c.warnings.map((y,I)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs text-yellow-700",children:[e.jsx(be,{className:"w-3 h-3 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:y})]},I))}),c.errors.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:c.errors.map((y,I)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs text-red-700",children:[e.jsx(Q,{className:"w-3 h-3 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:y})]},I))})]},c.studentId))})]})]}),f==="progress"&&e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-4",children:e.jsx(H,{className:"w-12 h-12 animate-spin text-red-600 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"מבצע מחיקה..."}),e.jsx("p",{className:"text-gray-600 mb-6",children:v.stage}),e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-2",children:[e.jsxs("span",{children:[v.current," מתוך ",v.total]}),e.jsxs("span",{children:[Math.round(v.current/v.total*100),"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-red-600 h-2 rounded-full transition-all duration-300",style:{width:`${v.current/v.total*100}%`}})})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-4",children:"אנא המתן עד לסיום הפעולה. אל תסגור את החלון."})]})}),f==="complete"&&e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"mb-4",children:e.jsx(ee,{className:"w-12 h-12 text-green-600 mx-auto"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"המחיקה הושלמה"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-900",children:w.success}),e.jsx("div",{className:"text-sm text-green-600",children:"נמחקו בהצלחה"})]}),e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-900",children:w.failed}),e.jsx("div",{className:"text-sm text-red-600",children:"נכשלו"})]})]}),w.details.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-gray-900",children:"פירוט מלא:"}),w.details.map((c,y)=>e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg ${c.success?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"}`,children:[c.success?e.jsx(ee,{className:"w-4 h-4 text-green-600"}):e.jsx(Q,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"flex-1",children:c.studentName}),c.error&&e.jsx("span",{className:"text-sm text-red-600",children:c.error})]},y))]})]})]}),f!=="progress"&&e.jsxs("div",{className:"flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[f==="preview"&&e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsxs("span",{children:["מוכן למחיקת ",R," תלמידים"]})]}),f==="complete"&&e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4"}),e.jsxs("span",{children:["הושלמו ",w.success," מחיקות"]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:x,className:"px-4 py-2 border border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:f==="complete"?"סגור":"ביטול"}),f==="preview"&&R>0&&e.jsxs("button",{onClick:W,disabled:m,className:"flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors disabled:opacity-50",children:[e.jsx(te,{className:"w-4 h-4"}),"מחק ",R," תלמידים"]})]})]})]})})},Bs=zs;function Ks(){const h=ps(),[n,T]=fs(),{user:g}=hs(),{currentSchoolYear:f,isLoading:i}=gs(),[m,k]=r.useState([]),[S,L]=r.useState(!0),[N,D]=r.useState(!1),[v,z]=r.useState(null),[w,p]=r.useState(n.get("search")||""),[b,W]=r.useState(n.get("search")||""),[x,R]=r.useState({orchestra:n.get("orchestra")||"",instrument:n.get("instrument")||"",stageLevel:n.get("stage")||""}),[j,F]=r.useState(1),[c,y]=r.useState(!0),[I,$]=r.useState(!1),[B,Y]=r.useState(!0),[G,Z]=r.useState(0),Ne=20,[Re,le]=r.useState(!1),[U,ne]=r.useState(null),[O,ve]=r.useState(n.get("view")||"table"),[Fe,ie]=r.useState(!1),[J,K]=r.useState(null),[ce,we]=r.useState(null),[Ue,Se]=r.useState(!1),[_,oe]=r.useState(null),[Oe,Ce]=r.useState(null),[de,se]=r.useState(null),[ze,me]=r.useState(!1),[Be,_e]=r.useState(!1),[Ve,xe]=r.useState(!1),[C,M]=r.useState(new Set),[Ye,_s]=r.useState(null),[A,ke]=r.useState(!1),[Ge,Xe]=r.useState(new Map);Ms(),r.useEffect(()=>{(async()=>{try{const t=await P.teachers.getTeachers(),o=new Map;t.forEach(u=>{const d=u.personalInfo?.fullName||u.fullName||u.name||"לא מוגדר";o.set(u._id,d)}),Xe(o)}catch(t){console.error("Error fetching teachers for lookup:",t)}})()},[]),r.useEffect(()=>{const s=setTimeout(()=>{W(w)},500);return()=>clearTimeout(s)},[w]),r.useEffect(()=>{const s=new URLSearchParams;w&&s.set("search",w),x.orchestra&&s.set("orchestra",x.orchestra),x.instrument&&s.set("instrument",x.instrument),x.stageLevel&&s.set("stage",x.stageLevel),O!=="table"&&s.set("view",O);const t=s.toString(),o=n.toString();t!==o&&T(s,{replace:!0})},[w,x.orchestra,x.instrument,x.stageLevel,O]),r.useEffect(()=>{const s=()=>{de&&se(null)};return document.addEventListener("click",s),()=>document.removeEventListener("click",s)},[de]),r.useEffect(()=>{i||V(1,!1)},[f,i]);const qe=()=>!g||g.role==="admin"||g.roles?.includes("admin")||g.role==="מנהל"||g.roles?.includes("מנהל")?"admin":g.role==="teacher"||g.roles?.includes("teacher")||g.role==="מורה"||g.roles?.includes("מורה")||g.teaching?.studentIds?.length>0?"teacher":g.role==="theory-teacher"||g.roles?.includes("theory-teacher")||g.roles?.includes("theory_teacher")||g.role==="מורה תיאוריה"||g.roles?.includes("מורה תיאוריה")?"theory-teacher":g.role==="conductor"||g.roles?.includes("conductor")||g.role==="מנצח"||g.roles?.includes("מנצח")||g.conducting?.orchestraIds?.length>0?"conductor":"admin",V=async(s=1,t=!1)=>{try{t?$(!0):(B?L(!0):D(!0),F(1),y(!0)),z(null);const o=qe();console.log("Loading students for user role:",o,"User:",g?.personalInfo?.fullName,"Page:",s);let u=[],d,X=null;if(o==="admin"){const a={...f?{schoolYearId:f._id}:{},...b?{name:b}:{},...x.instrument?{instrument:x.instrument}:{},...x.stageLevel?{stage:x.stageLevel}:{},page:s,limit:Ne},l=await P.students.getStudents(a);l.data&&l.pagination?(d=l.data,X=l.pagination,y(l.pagination.hasNextPage),Z(l.pagination.totalCount),console.log("Admin - loaded students page",s,":",l.data.length,"/",l.pagination.totalCount)):(d=l,y(!1),Z(l.length),console.log("Admin - loaded all students:",l.length))}else if(o==="teacher"){const l=(await P.teachers.getMyProfile())?.teaching?.studentIds||[];console.log("Teacher - assigned student IDs:",l),l.length>0?(d=await P.students.getBatchStudents(l),console.log("Teacher - loaded assigned students:",d.length)):(d=[],console.log("Teacher - no assigned students")),y(!1),Z(d.length)}else{const a={...f?{schoolYearId:f._id}:{},...b?{name:b}:{},...x.instrument?{instrument:x.instrument}:{},...x.stageLevel?{stage:x.stageLevel}:{},page:s,limit:Ne},l=await P.students.getStudents(a);l.data&&l.pagination?(d=l.data,X=l.pagination,y(l.pagination.hasNextPage),Z(l.pagination.totalCount),console.log("Other role - loaded students page",s,":",l.data.length,"/",l.pagination.totalCount)):(d=l,y(!1),Z(l.length),console.log("Other role - loaded all students:",l.length))}u=d;const $e=d.map(a=>({id:a._id,fullName:a.personalInfo.fullName,phone:a.personalInfo.phone,age:a.personalInfo.age,class:a.academicInfo.class,primaryInstrument:a.academicInfo.instrumentProgress.find(l=>l.isPrimary)?.instrumentName||a.academicInfo.instrumentProgress[0]?.instrumentName||"ללא כלי",currentStage:a.academicInfo.instrumentProgress.find(l=>l.isPrimary)?.currentStage||1,teacherAssignments:a.teacherAssignments,parentName:a.personalInfo.parentName,parentPhone:a.personalInfo.parentPhone,orchestraIds:a.enrollments.orchestraIds,isActive:a.isActive})).map(a=>({id:a.id,name:a.fullName,instrument:a.primaryInstrument,stageLevel:a.currentStage,orchestra:a.orchestraIds?.length>0?"תזמורת":"ללא תזמורת",grade:e.jsx(Ae,{status:"completed",children:a.class}),status:e.jsx(Ae,{status:a.isActive?"active":"inactive",children:a.isActive?"פעיל":"לא פעיל"}),teacherAssignments:a.teacherAssignments?.length||0,rawData:{...a,referenceCount:a.referenceCount||0,isOrphaned:a.isOrphaned||!1,hasNoRecentActivity:a.hasNoRecentActivity||!1,integrityStatus:a.integrityStatus||"healthy",lastActivity:a.lastActivity||null},originalStudent:d.find(l=>l._id===a.id),actions:e.jsxs("div",{className:"flex space-x-2 space-x-reverse",children:[A&&e.jsx("input",{type:"checkbox",checked:C.has(a.id),onChange:l=>{l.stopPropagation();const ue=new Set(C);l.target.checked?ue.add(a.id):ue.delete(a.id),M(ue)},className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),e.jsx("button",{className:"p-1.5 text-primary-600 hover:text-primary-900 hover:bg-primary-100 rounded transition-colors",onClick:l=>{l.stopPropagation(),console.log("Eye icon clicked for student:",a.id),he(a.id)},title:"צפה בפרטי התלמיד",children:e.jsx(ks,{className:"w-4 h-4"})}),e.jsx("button",{className:"p-1.5 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded transition-colors",onClick:l=>{l.stopPropagation(),He(a.id)},title:"ערוך פרטי התלמיד",children:e.jsx(Ls,{className:"w-4 h-4"})}),(a.referenceCount||a.rawData?.referenceCount||0)>0?e.jsx("button",{className:"p-1.5 text-orange-600 hover:text-orange-900 hover:bg-orange-50 rounded transition-colors",onClick:l=>{l.stopPropagation(),Ke(a.id,a.name)},title:"מחיקה מאובטחת",children:e.jsx(fe,{className:"w-4 h-4"})}):e.jsx("button",{className:"p-1.5 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors",onClick:l=>{l.stopPropagation(),ts(a.id,a.name)},title:"מחק תלמיד",children:e.jsx(te,{className:"w-4 h-4"})})]})}));k(t?a=>[...a,...$e]:$e)}catch(o){console.error("Error loading students:",o),z(o.message)}finally{L(!1),D(!1),$(!1),Y(!1)}},he=s=>{console.log("=== NAVIGATION DEBUG ==="),console.log("Student ID:",s),console.log("Target path:",`/students/${s}`),console.log("Current location:",window.location.pathname);const t=`/students/${s}`;try{h(t),console.log("Navigate function called successfully")}catch(o){console.error("Navigate failed, using window.location:",o),window.location.href=t}},He=async s=>{try{Se(!0),ne(s);const t=await P.students.getStudentById(s);we(t),le(!0)}catch(t){console.error("Error loading student for editing:",t),alert("שגיאה בטעינת נתוני התלמיד לעריכה")}finally{Se(!1)}},We=()=>{ne(null),le(!0)},Le=()=>{le(!1),ne(null),we(null)},Ze=async s=>{try{let t=U;if(U){if(await P.students.updateStudent(U,s),ce?.enrollments?.orchestraIds){const o=ce.enrollments.orchestraIds,u=s.enrollments?.orchestraIds||[];for(const d of o)if(!u.includes(d))try{await P.orchestras.removeMember(d,U),console.log(`Removed student ${U} from orchestra ${d}`)}catch(X){console.error(`Failed to remove from orchestra ${d}:`,X)}for(const d of u)if(!o.includes(d))try{await P.orchestras.addMember(d,U),console.log(`Added student ${U} to orchestra ${d}`)}catch(X){console.error(`Failed to add to orchestra ${d}:`,X)}}else if(s.enrollments?.orchestraIds?.length>0)for(const o of s.enrollments.orchestraIds)try{await P.orchestras.addMember(o,U),console.log(`Added student ${U} to orchestra ${o}`)}catch(u){console.error(`Failed to add to orchestra ${o}:`,u)}}else if(t=(await P.students.createStudent(s))._id,s.enrollments?.orchestraIds?.length>0)for(const u of s.enrollments.orchestraIds)try{await P.orchestras.addMember(u,t),console.log(`Added new student ${t} to orchestra ${u}`)}catch(d){console.error(`Failed to add to orchestra ${u}:`,d)}V(1,!1),Le()}catch(t){throw console.error("Error saving student:",t),t}},Je=()=>{Le()},Ie=async s=>{try{await P.students.deleteStudent(s),V(1,!1)}catch(t){console.error("Error deleting student:",t),alert("שגיאה במחיקת התלמיד")}},Ke=async(s,t)=>{K({id:s,name:t}),me(!0)},Qe=()=>{if(C.size===0){alert("יש לבחור לפחות תלמיד אחד");return}xe(!0)},es=()=>{ke(!A),M(new Set)},Pe=(s,t)=>{const o=new Set(C);t?o.add(s):o.delete(s),M(o)},ss=async(s,t)=>{try{await re.executeDelete(s,t),me(!1),K(null),V(1,!1)}catch(o){console.error("Error in safe deletion:",o),alert("שגיאה במחיקה המאובטחת")}},ts=(s,t)=>{K({id:s,name:t}),ie(!0)},as=()=>{J&&(Ie(J.id),K(null)),ie(!1)},rs=()=>{K(null),ie(!1)},ls=s=>{se(s)},De=(s,t,o,u)=>{const d=u?o+1:o-1;d<1||d>8||oe({studentId:s,studentName:t,currentLevel:o,newLevel:d})},ns=async()=>{if(_)try{Ce(_.studentId),await P.students.updateStudentStageLevel(_.studentId,_.newLevel),await V(1,!1),oe(null),se(null)}catch(s){console.error("Error updating stage level:",s),alert("שגיאה בעדכון השלב: "+s.message)}finally{Ce(null)}},is=()=>{oe(null),se(null)},cs=async()=>{const s=j+1;F(s),await V(s,!0)};r.useEffect(()=>{i||V(1,!1)},[b,x.orchestra,x.instrument,x.stageLevel]);const E=m,ge=G>0?G:m.length,os=m.filter(s=>s.rawData?.isActive).length,ds=m.filter(s=>!s.rawData?.isActive).length,ms=m.filter(s=>s.teacherAssignments>0).length,xs=[...A?[{key:"select",header:e.jsx("input",{type:"checkbox",checked:C.size===E.length&&E.length>0,onChange:s=>{s.target.checked?M(new Set(E.map(t=>t.id))):M(new Set)},className:"w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"}),render:s=>e.jsx("input",{type:"checkbox",checked:C.has(s.id),onChange:t=>{t.stopPropagation();const o=new Set(C);t.target.checked?o.add(s.id):o.delete(s.id),M(o)},onClick:t=>t.stopPropagation(),className:"w-4 h-4 rounded border-gray-300 text-primary-600 focus:ring-2 focus:ring-primary-500 cursor-pointer"}),width:"60px",align:"center"}]:[],{key:"name",header:"שם התלמיד"},{key:"instrument",header:"כלי נגינה"},{key:"teacherName",header:"שם המורה",render:s=>{const t=s.rawData?.teacherAssignments||s.originalStudent?.teacherAssignments||[];if(!t||t.length===0)return e.jsx("span",{className:"text-gray-400",children:"לא משוייך"});const u=t[0]?.teacherId;if(!u)return e.jsx("span",{className:"text-gray-400",children:"לא משוייך"});const d=Ge.get(u);return d?e.jsx("span",{className:"text-gray-700",children:d}):e.jsx("span",{className:"text-gray-400",children:"לא משוייך"})}},{key:"stageLevel",header:"שלב",align:"center",render:s=>{const t=de===s.id;return Oe===s.id?e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"w-16 h-8 flex items-center justify-center bg-blue-50 rounded-lg border-2 border-blue-200",children:e.jsx("span",{className:"text-blue-600 font-medium",children:"..."})})}):t?e.jsxs("div",{className:"flex items-center justify-center gap-1",onClick:u=>u.stopPropagation(),children:[e.jsx("button",{onClick:u=>{u.stopPropagation(),De(s.id,s.name,s.stageLevel,!1)},disabled:s.stageLevel<=1,className:"w-6 h-6 flex items-center justify-center bg-red-100 text-red-600 hover:bg-red-200 rounded-full disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-sm font-bold",title:"הורד שלב",children:"-"}),e.jsx("div",{className:"w-12 h-8 flex items-center justify-center bg-blue-50 rounded-lg border-2 border-blue-300 mx-1",children:e.jsx("span",{className:"text-blue-700 font-bold text-sm",children:s.stageLevel})}),e.jsx("button",{onClick:u=>{u.stopPropagation(),De(s.id,s.name,s.stageLevel,!0)},disabled:s.stageLevel>=8,className:"w-6 h-6 flex items-center justify-center bg-green-100 text-green-600 hover:bg-green-200 rounded-full disabled:opacity-30 disabled:cursor-not-allowed transition-colors text-sm font-bold",title:"העלה שלב",children:"+"})]}):e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("button",{onClick:u=>{u.stopPropagation(),ls(s.id)},className:"w-8 h-8 flex items-center justify-center text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors font-medium border border-transparent hover:border-blue-200",title:"לחץ לעריכת השלב",children:s.stageLevel})})}},{key:"orchestra",header:"תזמורת"},{key:"grade",header:"כיתה",align:"center"},{key:"status",header:"סטטוס",align:"center"},{key:"actions",header:"פעולות",align:"center",width:A?"120px":"140px"}];return S?e.jsx("div",{className:"flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(H,{className:"w-8 h-8 animate-spin mx-auto mb-4 text-primary-600"}),e.jsx("div",{className:"text-lg text-gray-600",children:"טוען תלמידים..."})]})}):v?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-red-600 text-lg mb-4",children:"❌ שגיאה בטעינת הנתונים"}),e.jsx("div",{className:"text-gray-600 mb-6",children:v}),e.jsx("button",{onClick:V,className:"px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600",children:"נסה שוב"})]}):e.jsxs("div",{className:"relative",children:[Re&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:Ue?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"טוען נתוני תלמיד..."})]}):e.jsx(us,{onSubmit:Ze,onCancel:Je,isEdit:!!U,initialData:ce})})}),e.jsx(q,{className:"mb-6",padding:"md",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(Is,{className:"absolute right-3 top-3 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"חיפוש תלמידים...",value:w,onChange:s=>p(s.target.value),className:"w-full pr-10 pl-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 placeholder-gray-500"})]})}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[e.jsxs("select",{value:x.orchestra,onChange:s=>R(t=>({...t,orchestra:s.target.value})),className:"px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"כל התזמורות"}),e.jsx("option",{value:"תזמורת",children:"תזמורת"}),e.jsx("option",{value:"ללא תזמורת",children:"ללא תזמורת"})]}),e.jsxs("select",{value:x.instrument,onChange:s=>R(t=>({...t,instrument:s.target.value})),className:"px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"כל הכלים"}),e.jsx("option",{value:"חלילית",children:"חלילית"}),e.jsx("option",{value:"חליל צד",children:"חליל צד"}),e.jsx("option",{value:"אבוב",children:"אבוב"}),e.jsx("option",{value:"בסון",children:"בסון"}),e.jsx("option",{value:"סקסופון",children:"סקסופון"}),e.jsx("option",{value:"קלרינט",children:"קלרינט"}),e.jsx("option",{value:"חצוצרה",children:"חצוצרה"}),e.jsx("option",{value:"קרן יער",children:"קרן יער"}),e.jsx("option",{value:"טרומבון",children:"טרומבון"}),e.jsx("option",{value:"טובה/בריטון",children:"טובה/בריטון"}),e.jsx("option",{value:"שירה",children:"שירה"}),e.jsx("option",{value:"כינור",children:"כינור"}),e.jsx("option",{value:"ויולה",children:"ויולה"}),e.jsx("option",{value:"צ'לו",children:"צ'לו"}),e.jsx("option",{value:"קונטרבס",children:"קונטרבס"}),e.jsx("option",{value:"פסנתר",children:"פסנתר"}),e.jsx("option",{value:"גיטרה",children:"גיטרה"}),e.jsx("option",{value:"גיטרה בס",children:"גיטרה בס"}),e.jsx("option",{value:"תופים",children:"תופים"})]}),e.jsxs("select",{value:x.stageLevel,onChange:s=>R(t=>({...t,stageLevel:s.target.value})),className:"px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900",children:[e.jsx("option",{value:"",children:"כל השלבים"}),[1,2,3,4,5,6,7,8].map(s=>e.jsxs("option",{value:s,children:["שלב ",s]},s))]}),e.jsxs("button",{onClick:We,className:"flex items-center px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors",children:[e.jsx(Ps,{className:"w-4 h-4 ml-2"}),"הוסף תלמיד"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-6",children:[e.jsx(q,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-primary-600 mb-1",children:ge}),e.jsx("div",{className:"text-sm text-gray-600",children:"סה״כ תלמידים"})]})}),e.jsx(q,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-success-600 mb-1",children:os}),e.jsx("div",{className:"text-sm text-gray-600",children:"פעילים"})]})}),e.jsx(q,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-orange-600 mb-1",children:ds}),e.jsx("div",{className:"text-sm text-gray-600",children:"לא פעילים"})]})}),e.jsx(q,{padding:"md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-purple-600 mb-1",children:ms}),e.jsx("div",{className:"text-sm text-gray-600",children:"עם שיעורים"})]})})]}),e.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-600",children:w||x.orchestra||x.instrument||x.stageLevel?e.jsxs("span",{children:["מציג ",m.length," תלמידים מתוך ",ge,' סה"כ',c&&e.jsx("span",{className:"text-primary-600 font-medium",children:" (טען עוד לתוצאות נוספות)"})]}):e.jsxs("span",{children:["מציג ",m.length," מתוך ",ge," תלמידים",c&&e.jsx("span",{className:"text-primary-600 font-medium",children:" (טען עוד לצפייה בנוספים)"})]})}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:es,className:`flex items-center px-3 py-1 rounded-lg text-xs transition-colors ${A?"bg-gray-500 text-white hover:bg-gray-600":"bg-blue-500 text-white hover:bg-blue-600"}`,title:A?"בטל בחירה מרובה":"הפעל בחירה מרובה",children:[e.jsx(ye,{className:"w-3 h-3 ml-1"}),A?"בטל בחירה":"בחירה מרובה"]}),A&&C.size>0&&e.jsxs("button",{onClick:Qe,className:"flex items-center px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-xs",children:[e.jsx(te,{className:"w-3 h-3 ml-1"}),"מחק נבחרים (",C.size,")"]}),e.jsxs("div",{className:"flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200 shadow-sm",children:[e.jsxs("button",{onClick:()=>ve("table"),className:`relative px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 ease-in-out flex items-center gap-2 ${O==="table"?"bg-white text-primary-700 shadow-sm border border-gray-200 ring-1 ring-primary-500/20":"text-gray-600 hover:text-gray-800 hover:bg-gray-100/50"}`,"aria-pressed":O==="table","aria-label":"תצוגת טבלה",children:[e.jsx(Ds,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"טבלה"}),O==="table"&&e.jsx("div",{className:"absolute inset-0 rounded-md bg-gradient-to-r from-primary-500/5 to-primary-600/5 pointer-events-none"})]}),e.jsxs("button",{onClick:()=>ve("grid"),className:`relative px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 ease-in-out flex items-center gap-2 ${O==="grid"?"bg-white text-primary-700 shadow-sm border border-gray-200 ring-1 ring-primary-500/20":"text-gray-600 hover:text-gray-800 hover:bg-gray-100/50"}`,"aria-pressed":O==="grid","aria-label":"תצוגת רשת",children:[e.jsx($s,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"רשת"}),O==="grid"&&e.jsx("div",{className:"absolute inset-0 rounded-md bg-gradient-to-r from-primary-500/5 to-primary-600/5 pointer-events-none"})]})]})]})]}),e.jsxs("div",{className:"relative",children:[N&&e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-10 rounded-lg",children:e.jsxs("div",{className:"text-center",children:[e.jsx(H,{className:"w-6 h-6 animate-spin mx-auto mb-2 text-primary-600"}),e.jsx("div",{className:"text-sm text-gray-600",children:"מחפש תלמידים..."})]})}),O==="table"?e.jsx(js,{columns:xs,data:E,onRowClick:s=>{if(A){const t=new Set(C);t.has(s.id)?t.delete(s.id):t.add(s.id),M(t)}else he(s.id)},rowClassName:s=>{const t=C.has(s.id);return bs("cursor-pointer transition-all duration-150",t?"bg-blue-50 hover:bg-blue-100 border-l-4 border-blue-500":"hover:bg-gray-50")}}):e.jsxs("div",{children:[A&&e.jsx("div",{className:"mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:C.size===E.length&&E.length>0,onChange:s=>{s.target.checked?M(new Set(E.map(t=>t.id))):M(new Set)},className:"w-4 h-4 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["בחר הכל (",E.length," תלמידים)"]})]}),C.size>0&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["נבחרו: ",C.size]}),e.jsx("button",{onClick:()=>M(new Set),className:"text-blue-600 hover:text-blue-800 underline",children:"נקה בחירה"})]})]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6",children:E.map(s=>e.jsx(Ts,{student:s.originalStudent,showInstruments:!0,showTeacherAssignments:!0,showParentContact:!1,onClick:()=>{A?Pe(s.id,!C.has(s.id)):he(s.id)},onDelete:Ie,className:"h-full hover:shadow-lg transition-all duration-200 hover:scale-[1.02] hover:-translate-y-1",isSelectMode:A,isSelected:C.has(s.id),onSelectionChange:Pe},s.id))})]}),E.length===0&&!S&&!N&&e.jsx("div",{className:"text-center py-12 text-gray-500",children:"לא נמצאו תלמידים התואמים לחיפוש"})]}),c&&E.length>0&&!S&&e.jsx("div",{className:"flex justify-center mt-8 mb-6",children:e.jsx("button",{onClick:cs,disabled:I,className:"flex items-center gap-2 px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:shadow-lg",children:I?e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"טוען עוד תלמידים..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(As,{className:"w-5 h-5"}),e.jsx("span",{children:"טען עוד תלמידים"})]})})}),e.jsx(pe,{isOpen:Fe,title:"מחיקת תלמיד",message:`האם אתה בטוח שברצונך למחוק את התלמיד ${J?.name}? פעולה זו לא ניתנת לביטול.`,confirmText:"מחק",cancelText:"ביטול",onConfirm:as,onCancel:rs,variant:"danger"}),e.jsx(pe,{isOpen:!!_,title:"עדכון שלב התלמיד",message:_?`האם אתה בטוח שברצונך לשנות את שלב התלמיד "${_.studentName}" משלב ${_.currentLevel} לשלב ${_.newLevel}?`:"",confirmText:"עדכן שלב",cancelText:"ביטול",onConfirm:ns,onCancel:is,variant:"primary"}),e.jsx(Fs,{isOpen:ze,studentId:J?.id||"",studentName:J?.name||"",onClose:()=>me(!1),onConfirm:ss}),e.jsx(Os,{isOpen:Be,preview:Ye,onClose:()=>_e(!1)}),e.jsx(Bs,{isOpen:Ve,selectedStudentIds:Array.from(C),onClose:()=>xe(!1),onComplete:()=>{xe(!1),M(new Set),ke(!1),V(1,!1)}})]})}export{Ks as default};
