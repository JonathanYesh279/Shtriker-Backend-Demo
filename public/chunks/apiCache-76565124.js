import{r as E}from"./vendor-a78d685e.js";import{a as c}from"./cascade-deletion-cf3b4f10.js";import{t as C}from"./theoryEnrollmentService-bf9cdc6c.js";import{a as A,u as d,b as L}from"./query-84c35d59.js";import"./utils-a4d8ec6e.js";const i={STATIC_DATA_STALE_TIME:10*60*1e3,STATIC_DATA_CACHE_TIME:30*60*1e3,DYNAMIC_DATA_STALE_TIME:2*60*1e3,DYNAMIC_DATA_CACHE_TIME:5*60*1e3,REALTIME_DATA_STALE_TIME:30*1e3,REALTIME_DATA_CACHE_TIME:60*1e3},r={STUDENTS:["students"],STUDENT:e=>["student",e],STUDENT_THEORY_LESSONS:e=>["student",e,"theory-lessons"],STUDENT_ORCHESTRAS:e=>["student",e,"orchestras"],STUDENT_SCHEDULE:e=>["student",e,"schedule"],STUDENT_ATTENDANCE:e=>["student",e,"attendance"],STUDENT_DOCUMENTS:e=>["student",e,"documents"],TEACHERS:["teachers"],TEACHER:e=>["teacher",e],TEACHER_SCHEDULE:e=>["teacher",e,"schedule"],THEORY_LESSONS:["theory-lessons"],THEORY_LESSON:e=>["theory-lesson",e],ORCHESTRAS:["orchestras"],ORCHESTRA:e=>["orchestra",e],SCHOOL_YEARS:["school-years"],HOLIDAYS:["holidays"],INSTRUMENTS:["instruments"]},h=new Map;function S(e,t){if(h.has(e))return h.get(e);const a=t().finally(()=>{h.delete(e)});return h.set(e,a),a}const y={students:{getAll:()=>S("students-all",()=>c.students.getAllStudents()),getById:e=>S(`student-${e}`,()=>c.students.getStudentById(e)),update:(e,t)=>c.students.updateStudent(e,t)},teachers:{getAll:()=>S("teachers-all",()=>c.teachers.getAllTeachers()),getById:e=>S(`teacher-${e}`,()=>c.teachers.getTeacherById(e))},theoryLessons:{getAll:()=>S("theory-lessons-all",()=>c.theoryLessons.getTheoryLessons()),getById:e=>S(`theory-lesson-${e}`,()=>c.theoryLessons.getTheoryLessonById(e)),addStudent:(e,t)=>C.enrollStudent(e,t,{method:"manual",performedBy:"teacher",reason:"Manual enrollment"}),removeStudent:(e,t)=>C.unenrollStudent(e,t,{reason:"Manual unenrollment"})},orchestras:{getAll:()=>S("orchestras-all",()=>c.orchestras.getAllOrchestras()),getById:e=>S(`orchestra-${e}`,()=>c.orchestras.getOrchestraById(e))},schoolData:{getSchoolYears:()=>S("school-years",()=>c.schoolData?.getSchoolYears?.()||Promise.resolve([])),getHolidays:()=>S("holidays",()=>c.schoolData?.getHolidays?.()||Promise.resolve([])),getInstruments:()=>S("instruments",()=>c.schoolData?.getInstruments?.()||Promise.resolve([]))}};function D(e){return A({queryKey:r.STUDENT(e||""),queryFn:()=>y.students.getById(e),enabled:!!e,staleTime:i.DYNAMIC_DATA_STALE_TIME,gcTime:i.DYNAMIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function g(){return A({queryKey:r.THEORY_LESSONS,queryFn:y.theoryLessons.getAll,staleTime:i.DYNAMIC_DATA_STALE_TIME,gcTime:i.DYNAMIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function p(e){const{data:t=[]}=g(),{data:a}=D(e);return E.useMemo(()=>!e||!t.length?[]:t.filter(o=>o.studentIds?.includes(e)||a?.theoryLessonIds?.includes(o._id)),[t,e,a?.theoryLessonIds])}function H(e,t,a){const{data:o=[]}=g(),{data:n}=D(e);return E.useMemo(()=>!e||!o.length?[]:o.filter(s=>{if(s.studentIds?.includes(e)||n?.theoryLessonIds?.includes(s._id)||s.maxStudents&&s.studentIds?.length>=s.maxStudents)return!1;const T=!s.targetGrades||s.targetGrades.length===0||s.targetGrades.includes(t),_=!s.level||s.level===a||s.level==="all";return T&&_}).map(s=>({...s,isCompatible:!0,gradeCompatible:!0,levelCompatible:!0,isFull:!1,isEnrolled:!1})),[o,e,n?.theoryLessonIds,t,a])}function m(){return A({queryKey:r.ORCHESTRAS,queryFn:y.orchestras.getAll,staleTime:i.DYNAMIC_DATA_STALE_TIME,gcTime:i.DYNAMIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function R(e){const{data:t=[]}=m(),{data:a}=D(e);return E.useMemo(()=>!e||!t.length?[]:t.filter(o=>o.memberIds?.includes(e)||a?.orchestraIds?.includes(o._id)),[t,e,a?.orchestraIds])}function v(){return A({queryKey:r.TEACHERS,queryFn:y.teachers.getAll,staleTime:i.STATIC_DATA_STALE_TIME,gcTime:i.STATIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function Y(e){return A({queryKey:r.TEACHER(e||""),queryFn:()=>y.teachers.getById(e),enabled:!!e,staleTime:i.DYNAMIC_DATA_STALE_TIME,gcTime:i.DYNAMIC_DATA_CACHE_TIME,refetchOnWindowFocus:!1})}function q(e){const t=d(),a=L({mutationFn:({lessonId:n})=>y.theoryLessons.addStudent(n,e),onMutate:async({lessonId:n})=>{await t.cancelQueries({queryKey:r.THEORY_LESSONS}),await t.cancelQueries({queryKey:r.STUDENT(e)});const s=t.getQueryData(r.THEORY_LESSONS),u=t.getQueryData(r.STUDENT(e));return t.setQueryData(r.THEORY_LESSONS,l=>l?.map(T=>T._id===n?{...T,studentIds:[...T.studentIds||[],e]}:T)||[]),t.setQueryData(r.STUDENT(e),l=>l&&{...l,theoryLessonIds:[...l.theoryLessonIds||[],n]}),{previousTheoryLessons:s,previousStudent:u}},onError:(n,s,u)=>{u?.previousTheoryLessons&&t.setQueryData(r.THEORY_LESSONS,u.previousTheoryLessons),u?.previousStudent&&t.setQueryData(r.STUDENT(e),u.previousStudent)},onSettled:()=>{t.invalidateQueries({queryKey:r.THEORY_LESSONS}),t.invalidateQueries({queryKey:r.STUDENT(e)})}}),o=L({mutationFn:({lessonId:n})=>y.theoryLessons.removeStudent(n,e),onMutate:async({lessonId:n})=>{await t.cancelQueries({queryKey:r.THEORY_LESSONS}),await t.cancelQueries({queryKey:r.STUDENT(e)});const s=t.getQueryData(r.THEORY_LESSONS),u=t.getQueryData(r.STUDENT(e));return t.setQueryData(r.THEORY_LESSONS,l=>l?.map(T=>T._id===n?{...T,studentIds:T.studentIds?.filter(_=>_!==e)||[]}:T)||[]),t.setQueryData(r.STUDENT(e),l=>l&&{...l,theoryLessonIds:l.theoryLessonIds?.filter(T=>T!==n)||[]}),{previousTheoryLessons:s,previousStudent:u}},onError:(n,s,u)=>{u?.previousTheoryLessons&&t.setQueryData(r.THEORY_LESSONS,u.previousTheoryLessons),u?.previousStudent&&t.setQueryData(r.STUDENT(e),u.previousStudent)},onSettled:()=>{t.invalidateQueries({queryKey:r.THEORY_LESSONS}),t.invalidateQueries({queryKey:r.STUDENT(e)})}});return{enroll:a.mutate,unenroll:o.mutate,isEnrolling:a.isPending,isUnenrolling:o.isPending,error:a.error||o.error}}function Q(){const e=d(),t=E.useCallback(n=>{e.prefetchQuery({queryKey:r.STUDENT(n),queryFn:()=>y.students.getById(n),staleTime:i.DYNAMIC_DATA_STALE_TIME})},[e]),a=E.useCallback(()=>{e.prefetchQuery({queryKey:r.THEORY_LESSONS,queryFn:y.theoryLessons.getAll,staleTime:i.DYNAMIC_DATA_STALE_TIME})},[e]),o=E.useCallback(()=>{e.prefetchQuery({queryKey:r.ORCHESTRAS,queryFn:y.orchestras.getAll,staleTime:i.DYNAMIC_DATA_STALE_TIME})},[e]);return{prefetchStudent:t,prefetchTheoryLessons:a,prefetchOrchestras:o}}function U(){const e=d(),t=E.useCallback(()=>{e.clear()},[e]),a=E.useCallback(s=>{e.invalidateQueries({queryKey:r.STUDENT(s)})},[e]),o=E.useCallback(()=>{e.invalidateQueries({queryKey:r.THEORY_LESSONS})},[e]),n=E.useCallback(()=>{const s=e.getQueryCache();return{totalQueries:s.getAll().length,cachedData:s.getAll().reduce((u,l)=>(l.state.data&&u++,u),0)}},[e]);return{clearCache:t,invalidateStudent:a,invalidateTheoryLessons:o,getCacheStats:n}}export{r as QUERY_KEYS,y as cachedApiService,H as useAvailableTheoryLessons,U as useCacheManagement,m as useOrchestras,Q as usePrefetch,D as useStudent,R as useStudentOrchestras,p as useStudentTheoryLessons,Y as useTeacher,v as useTeachers,q as useTheoryLessonEnrollment,g as useTheoryLessons};
